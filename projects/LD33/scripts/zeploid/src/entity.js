base.registerModule("entity",function(t){var i=base.importModule("run"),e=base.importModule("engine"),o=base.importModule("util"),n=base.importModule("level"),s=base.importModule("visual"),r=(base.importModule("data"),{X:0,Y:1}),c={LEFT:0,RIGHT:1},h={GRAVITY:base.abstractField,AIR_RESISTANCE:base.abstractField,FLOOR_FRICTION:base.abstractField,HORZ_SPEED:base.abstractField,VERT_SPEED:base.abstractField};t.physicsProvider=h,t.setPhysicsProvider=function(i){h=i,t.physicsProvider=i};var l=base.extend(e.Sprite,"Entity",{constructor:function(t,i,e){this.world=t,this.position=i,this.clip=e},getBox:function(){return new o.Rect(this.position.x,this.position.y,this.clip[0],this.clip[1])},renderWithImage:function(t,i){var e=this.getRenderVector(),o=n.tileProvider.tileSize;t.drawImage(i,e.x*o,e.y*o)},getRenderVector:function(){var t=this.world.getRenderBounds();return o.Vector.get(this.position.x,this.position.y).sub(o.Vector.get(t.left,t.top))}});l.prototype.compile();var d=base.extend(l,"Mob",{constructor:function(t,i,e,n){this.constructor$Entity(t,i,n),this.velocity=o.Vector.get(0,0),this.graphic=e,this.onGround=!1,this.timeOnGroundAndMoving=0,this.direction=c.LEFT,this.speed=h.HORZ_SPEED,this.jumpSpeed=h.VERT_SPEED},update:e.listener(e.EventTick.ID,function(t){this.velocity.y+=h.GRAVITY,this.velocity=this.velocity.scale(h.AIR_RESISTANCE),this.onGround=!1,this.position.x+=this.velocity.x,this.handlePhysics(r.X,t.tickCount),this.position.y+=this.velocity.y,this.handlePhysics(r.Y,t.tickCount),this.onGround&&0!==this.velocity.x&&this.timeOnGroundAndMoving++,this.velocity.x<0?this.direction=c.LEFT:this.velocity.x>0&&(this.direction=c.RIGHT)}),handlePhysics:function(t){for(var i,e=this.getBox(),o=Math.round(this.position.x),n=Math.round(this.position.y),s=o-1;o+1>=s;s++)for(var r=n-1;n+1>=r;r++){var c=this.world.getTile(s,r);if(null!==c&&(i=c.getBox(s,r),c.isSolid()&&null!==i&&e.colliderect(i)))return void this.handleCollision(e,i,t)}},handleCollision:function(t,i,e){e==r.X?(this.velocity.x<0?this.position.x=i.right:this.position.x=i.left-t.width,this.velocity.x=0):(this.velocity.y<0?this.position.y=i.bottom:(this.position.y=i.top-t.height,this.onGround=!0,this.velocity.x*=h.FLOOR_FRICTION),this.velocity.y=0)},render:e.listener(e.EventRender.ID,function(t){var i,e=Math.round(this.timeOnGroundAndMoving/1e3%(this.graphic.left.length-1));i=this.direction==c.LEFT?this.graphic.left[e]:this.graphic.right[e],this.renderWithImage(t.context,i)}),moveLeft:function(t){this.velocity.x=-t},moveRight:function(t){this.velocity.x=t},moveUp:function(t){this.onGround&&(this.velocity.y=-t)},getCollisionPrecedence:function(){return 0}});t.Mob=d,d.prototype.compile(),t.Player=base.extend(d,"Player",{constructor:function(t,i,e){this.constructor$Mob(t,i,s.graphicsProvider.textures.PLAYER,e)},getRenderVector:function(){var t=n.tileProvider.tileSize;return o.Vector.get(i.SCREEN_WIDTH/t/2,i.SCREEN_HEIGHT/t/2)},moveLeft:e.listener(e.EventKeyPressed.ID_A,function(t){this.moveLeft$Mob(this.speed)}),moveRight:e.listener(e.EventKeyPressed.ID_D,function(t){this.moveRight$Mob(this.speed)}),moveUp:e.listener(e.EventKeyPressed.ID_W,function(t){this.moveUp$Mob(this.jumpSpeed)}),getCollisionPrecedence:function(){return 1}}),t.Player.prototype.compile();var a=base.extend(l,"Collectable",{constructor:function(t,i,e,o){this.constructor$Entity(t,i,o),this.graphic=e},render:e.listener(e.EventRender.ID,function(t){this.renderWithImage(t.context,this.graphic)})});t.Collectable=a,a.prototype.compile()});