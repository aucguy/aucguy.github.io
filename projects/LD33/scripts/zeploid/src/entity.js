base.registerModule("entity",function(i){var e=base.importModule("run"),t=base.importModule("engine"),n=base.importModule("util"),s=base.importModule("level"),o=base.importModule("visual"),r=(base.importModule("data"),0),c=1,h=0,l=1,d={GRAVITY:base.abstractField,AIR_RESISTANCE:base.abstractField,FLOOR_FRICTION:base.abstractField,HORZ_SPEED:base.abstractField,VERT_SPEED:base.abstractField};i.physicsProvider=d,i.setPhysicsProvider=function(t){d=t,i.physicsProvider=t};var a=base.extend(t.Sprite,"Entity",{constructor:function(t,i,e){this.world=t,this.position=i,this.clip=e},getBox:function(){return new n.Rect(this.position.x,this.position.y,this.clip[0],this.clip[1])},renderWithImage:function(t,i){var e=this.getRenderVector(),o=s.tileProvider.tileSize;t.drawImage(i,e.x*o,e.y*o)},getRenderVector:function(){var t=this.world.getRenderBounds();return n.Vector.get(this.position.x,this.position.y).sub(n.Vector.get(t.left,t.top))}});a.prototype.compile();var u=base.extend(a,"Mob",{constructor:function(t,i,e,o){this.constructor$Entity(t,i,o),this.velocity=n.Vector.get(0,0),this.graphic=e,this.onGround=!1,this.timeOnGroundAndMoving=0,this.direction=h,this.speed=d.HORZ_SPEED,this.jumpSpeed=d.VERT_SPEED},update:t.listener(t.EventTick.ID,function(t){this.velocity.y+=d.GRAVITY,this.velocity=this.velocity.scale(d.AIR_RESISTANCE),this.onGround=!1,this.position.x+=this.velocity.x,this.handlePhysics(r,t.tickCount),this.position.y+=this.velocity.y,this.handlePhysics(c,t.tickCount),this.onGround&&0!==this.velocity.x&&this.timeOnGroundAndMoving++,this.velocity.x<0?this.direction=h:0<this.velocity.x&&(this.direction=l)}),handlePhysics:function(t){for(var i,e=this.getBox(),o=Math.round(this.position.x),n=Math.round(this.position.y),s=o-1;s<=o+1;s++)for(var r=n-1;r<=n+1;r++){var c=this.world.getTile(s,r);if(null!==c&&(i=c.getBox(s,r),c.isSolid()&&null!==i&&e.colliderect(i)))return void this.handleCollision(e,i,t)}},handleCollision:function(t,i,e){e==r?(this.velocity.x<0?this.position.x=i.right:this.position.x=i.left-t.width,this.velocity.x=0):(this.velocity.y<0?this.position.y=i.bottom:(this.position.y=i.top-t.height,this.onGround=!0,this.velocity.x*=d.FLOOR_FRICTION),this.velocity.y=0)},render:t.listener(t.EventRender.ID,function(t){var i,e=Math.round(this.timeOnGroundAndMoving/1e3%(this.graphic.left.length-1));i=this.direction==h?this.graphic.left[e]:this.graphic.right[e],this.renderWithImage(t.context,i)}),moveLeft:function(t){this.velocity.x=-t},moveRight:function(t){this.velocity.x=t},moveUp:function(t){this.onGround&&(this.velocity.y=-t)},getCollisionPrecedence:function(){return 0}});(i.Mob=u).prototype.compile(),i.Player=base.extend(u,"Player",{constructor:function(t,i,e){this.constructor$Mob(t,i,o.graphicsProvider.textures.PLAYER,e)},getRenderVector:function(){var t=s.tileProvider.tileSize;return n.Vector.get(e.SCREEN_WIDTH/t/2,e.SCREEN_HEIGHT/t/2)},moveLeft:t.listener(t.EventKeyPressed.ID_A,function(t){this.moveLeft$Mob(this.speed)}),moveRight:t.listener(t.EventKeyPressed.ID_D,function(t){this.moveRight$Mob(this.speed)}),moveUp:t.listener(t.EventKeyPressed.ID_W,function(t){this.moveUp$Mob(this.jumpSpeed)}),getCollisionPrecedence:function(){return 1}}),i.Player.prototype.compile();var p=base.extend(a,"Collectable",{constructor:function(t,i,e,o){this.constructor$Entity(t,i,o),this.graphic=e},render:t.listener(t.EventRender.ID,function(t){this.renderWithImage(t.context,this.graphic)})});(i.Collectable=p).prototype.compile()});