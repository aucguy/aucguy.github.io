base.registerModule("engine",function(s){function o(e,t){var n=document.createElement("canvas");n.width=e,n.height=t;var s=n.getContext("2d");return s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,e,t),n}s.DISPLAY_ID=null,s.init=function(){m.instance=new m,m.instance.init()},s.makeCanvas=o,s.loadImage=function(t,n,e){var s=o(t,n),i=s.getContext("2d"),r=new Image;return r.addEventListener("load",function(e){i.clearRect(0,0,t,n),i.drawImage(r,0,0)}),r.src=e,s};var u=base.extend(Object,"Event",{constructor:function(e){this.id=e,this.canceled=!1},id:null,canceled:null});u.current_id=0,(s.Event=u).nextEventId=function(){return u.current_id++};var e=base.extend(u,"EventMouse",{constructor:function(e,t,n){this.constructor$Event(n),this.x=e,this.y=t},x:null,y:null});s.EventMouse=e;var i=base.extend(e,"EventMouseDown",{constructor:function(e,t){this.constructor$EventMouse(e,t,i.ID)}});(s.EventMouseDown=i).ID=u.nextEventId();var r=base.extend(e,"EventMouseUp",{constructor:function(e,t){this.constructor$EventMouse(e,t,r.ID)}});(s.EventMouseUp=r).ID=u.nextEventId();var c=base.extend(e,"EventMouseMove",{constructor:function(e,t){this.constructor$EventMouse(e,t,c.ID)}});(s.EventMouseMove=c).ID=u.nextEventId();var d=base.extend(u,"EventKey",{constructor:function(e,t){this.constructor$Event(t),this.key=e}});function t(){var t=base.extend(d,"",{constructor:function(e){this.constructor$EventKey(e,t.keybindings[e])}});return d.registerIds(t),t}(s.EventKey=d).prototype.key=null,d.keys=["W","A","S","D"," SPACE","192:GRAVE"],d.registerIds=function(e){e.keybindings={};for(var t=0;t<d.keys.length;t++){var n,s,i=d.keys[t],r=i.indexOf(":");n=0<r?parseInt(i.slice(0,r)):i[0].toUpperCase().charCodeAt(0),s=1==i.length?i.toUpperCase():r<1?i.slice(1,i.length).toUpperCase():i.slice(r+1);var o=u.nextEventId();e["ID_"+s]=o,e.keybindings[n]=o}};var n=t();s.EventKeyDown=n;var h=t();s.EventKeyUp=h;var a=t();s.EventKeyPressed=a;var l=base.extend(u,"EventTick",{constructor:function e(t){this.constructor$Event(e.ID),this.tickCount=t}});(s.EventTick=l).ID=u.nextEventId();var p=base.extend(u,"EventRender",{constructor:function e(t){this.constructor$Event(e.ID),this.context=t},context:null});(s.EventRender=p).ID=u.nextEventId();var v=base.extend(u,"EventAdded",{constructor:function(e){this.constructor$Event(v.ID),this.group=e},group:null});(s.EventAdded=v).ID=u.nextEventId();var f=base.extend(u,"EventRemoved",{constructor:function(e){this.constructor$Event(f.ID),this.group=e},group:null});(s.EventRemoved=f).ID=u.nextEventId();var y=base.extend(u,"EventCompilePassers",{constructor:function(){this.constructor$Event(y.ID)}});function E(e,t){return t._$event_id=e,t}(s.EventCompilePassers=y).ID=u.nextEventId(),s.listener=E;var g=base.extend(Object,"Sprite",{constructor:function(){this.references=0,this.parentGroup=null},handlers:{},parentGroup:null,onEvent:function(e){this.handlers.hasOwnProperty(e.id)&&this.handlers[e.id](this,e)},compile:function(){"use strict";var e={};for(var t in this)if(-1==t.indexOf("$")){var n=this[t];"function"==typeof n&&void 0!==n._$event_id&&(void 0===e[n._$event_id]&&(e[n._$event_id]=[]),e[n._$event_id].push(n),n.$name=t)}for(var s in this.handlers={},e){for(var i=e[s],r=[],o=0;o<i.length;o++){var u=i[o];r.push("s."),r.push(u.$name),r.push("(e);")}this.handlers[s]=new Function("s","e",r.join(""))}},onAdded:E(v.ID,function(e){this.parentGroup=e.group}),onRemoved:E(f.ID,function(e){this.parentGroup=null})});g.prototype.compile(),s.Sprite=g;var I=base.extend(g,"Group",{constructor:function(){this.constructor$Sprite(),this.sprites=[],this.spriteDeltas=[],this.dirty=!0},sprites:null,dirty:!1,spriteDeltas:null,addSprite:function(e){this.spriteDeltas.push({type:0,sprite:e}),this.dirty=!0,m.instance.addDirtyGroup(this)},removeSprite:function(e){-1!=this.sprites.indexOf(e)&&(this.spriteDeltas.push({type:1,sprite:e}),this.dirty=!0,m.instance.addDirtyGroup(this))},forEachSprite:function(e){for(var t=0;t<this.sprites.length;t++)e(this.sprites[t])},compilePassers:function(){this.compile$Sprite(),this.listeners=this.handlers;var e,t={};for(e in this.listeners)t[e]=["var x;s.listeners[",e,"](s,e);"];for(var n=0;n<this.sprites.length;n++){var s=this.sprites[n];for(e in s instanceof I&&s.dirty&&s.refresh(),s.handlers)void 0===t[e]&&(t[e]=["var x;"]),t[e].push("x=s.sprites["),t[e].push(n),t[e].push("];x.handlers["),t[e].push(e),t[e].push("](x,e);")}for(e in this.handlers={},t)this.handlers[e]=new Function("s","e",t[e].join(""))},refresh:function(){for(var e=0;e<this.spriteDeltas.length;e++){var t=this.spriteDeltas[e];0===t.type?(this.sprites.push(t.sprite),t.sprite.onEvent(new v(this))):(this.sprites.splice(this.sprites.indexOf(t.sprite),1),t.sprite.onEvent(new f(this)))}this.spriteDeltas=[],this.compilePassers(),this.dirty=!1,null!==this.parentGroup&&m.instance.addDirtyGroup(this.parentGroup)}});s.Group=I;var D=base.extend(I,"SegmentedGroup",{constructor:function(e){this.constructor$Group(),this.segmentSize=Math.sqrt(e)},segmentSize:null,addSprite:function(e){(0===this.sprites.length||this.sprites[this.sprites.length-1].sprites.length>=this.segmentSize)&&this.addSprite$Group(new I),this.sprites[this.sprites.length-1].addSprite(e)},removeSprite:function(e){for(var t=0;t<this.sprites.length;t++){var n=this.sprites[t];if(-1!=n.sprites.indexOf(e))return void n.removeSprite(e)}},forEachSprite:function(e){for(var t=0;t<this.sprites.length;t++)this.sprites[t].forEachSprite(e)}});s.SegmentedGroup=D;var m=base.extend(I,"World",{constructor:function e(){this.constructor$Group(),this.dirtyGroups=[],this.inter=new w,this.tickCount=0;var t=e.instance=this,n=document.getElementById(s.DISPLAY_ID);base.addListener(n,"mousedown",function(e){t.handleMouseDown(e)}),base.addListener(n,"mousemove",function(e){t.handleMouseMove(e)}),base.addListener(n,"mouseup",function(e){t.handleMouseUp(e)}),base.addListener(n,"keydown",function(e){t.handleKeyDown(e)}),base.addListener(n,"keyup",function(e){t.handleKeyUp(e)}),base.addListener(n,"blur",function(e){t.handleBlur(e)})},mouseDown:!1,dirtyGroups:null,inter:null,init:function(){this.addSprite(this.inter)},handleError:function(e,t){},addDirtyGroup:function(e){-1==this.dirtyGroups.indexOf(e)&&this.dirtyGroups.push(e)},refreshListeners:function(){for(var e=0;e<this.dirtyGroups.length;e++)this.dirtyGroups[e].refresh();this.dirtyGroups=[]},tick:function(){this.refreshListeners(),this.onEvent(new l(this.tickCount++))},render:function(e){e.fillStyle="#000000",e.fillRect(0,0,e.canvas.width,e.canvas.height),this.onEvent(new p(e))},handleMouseDown:function(e){if(x(e.button)){this.mouseDown=!0;var t=e.clientX-document.getElementById(s.DISPLAY_ID).getBoundingClientRect().left,n=e.clientY-document.getElementById(s.DISPLAY_ID).getBoundingClientRect().top;this.onEvent(new i(t,n))}},handleMouseMove:function(e){var t=e.clientX-document.getElementById(s.DISPLAY_ID).getBoundingClientRect().left,n=e.clientY-document.getElementById(s.DISPLAY_ID).getBoundingClientRect().top;this.onEvent(new c(t,n))},handleMouseUp:function(e){if(x(e.button)){this.mouseDown=!1;var t=e.clientX-document.getElementById(s.DISPLAY_ID).getBoundingClientRect().left,n=e.clientY-document.getElementById(s.DISPLAY_ID).getBoundingClientRect().top;this.onEvent(new r(t,n))}},handleKeyDown:function(e){this.inter.onKeyDown(e),this.onEvent(new n(e.keyCode))},handleKeyUp:function(e){this.inter.onKeyUp(e),this.onEvent(new h(e.keyCode))},handleBlur:function(e){this.inter.onBlur(e)}});function x(e){for(var t=1;t<9;t++)if(-1<navigator.appVersion.indexOf("rv:"+t))return 1==e;return 0===e}(s.World=m).instance=null;var S=base.extend(g,"SimpleGraphic",{constructor:function(e,t,n){g.call(this),this.canvas=e,this.x=t,this.y=n},canvas:null,x:null,y:null,render:E(p.ID,function(e){e.context.drawImage(this.getCanvas(),this.getX(),this.getY())}),getCanvas:function(){return this.canvas},getX:function(){return this.x},getY:function(){return this.y}});(s.SimpleGraphic=S).prototype.compile(S);var w=base.extend(g,"Interface",{constructor:function(){this.constructor$Sprite(),this.mouseX=0,this.mouseY=0,this.pressedKeys=[]},mouseX:null,mouseY:null,pressedKeys:null,onMouseMove:E(c.ID,function(e){this.mouseX=e.x,this.mouseY=e.y}),onKeyDown:function(e){-1==this.pressedKeys.indexOf(e.keyCode)&&this.pressedKeys.push(e.keyCode)},onKeyUp:function(e){-1!=this.pressedKeys.indexOf(e.keyCode)&&this.pressedKeys.splice(this.pressedKeys.indexOf(e.keyCode),1)},onBlur:function(e){this.pressedKeys=[]},onTick:E(l.ID,function(e){for(var t=0;t<this.pressedKeys.length;t++)this.parentGroup.onEvent(new a(this.pressedKeys[t]))})});(s.Interface=w).prototype.compile(),s.tick=function(){m.instance.tick(),m.instance.render(document.getElementById(s.DISPLAY_ID).getContext("2d"))}});