base.registerModule("minions",function(i){function t(i,t){l.MenuPlay.instance.variables[i]=t}function n(){var i=new d,t=g.instance.stations,n=g.instance.stationFields;if(!(n.supplies.mana<p.COST_SUMMON))for(var s=0;s<t.length;s++){var e=t[s];if(e.addMinion(i))return n.supplies.mana-=p.COST_SUMMON,void n.syncGui()}}function s(i,t){return function(){i.produceMore(t)}}function e(i,t){return function(){i.produceLess(t)}}function o(i,t){return function(){if(i.minions.length>t){var n={station:i,slot:t};g.instance.setSelectedSlot(n)}}}function h(i){return function(){var t=g.instance.getSelectedMinion();null!==t&&(g.instance.selectedSlot.station.removeMinion(t),g.instance.selectedSlot.station.flushRemovals(),i.addMinion(t))}}function r(i){return function(){var t=g.instance.getSelectedMinion();if(null!==t){var n=g.instance.stationWorkshop.supplies;if(n[i+"A"]>0){n[i+"A"]--,t.equipment=i;var s=g.instance.selectedSlot;t.syncSlot(s.station.name,s.slot),g.instance.syncGui()}}}}function a(){g.instance.parentGroup.removeSprite(g.instance),c.menuManager.setMenu(new l.MenuPlay("gui/instructions"))}var l=base.importModule("menu"),u=base.importModule("engine"),p=base.importModule("data"),c=base.importModule("main"),d=base.extend(Object,"Minion",{constructor:function(){this.skillFarming=1,this.skillMining=1,this.skillCrafting=1,this.skillFighting=1,this.hp=p.MAX_HP,this.name="John Smith",this.healing=!1,this.equipment="none",this.spells=[]},syncSlot:function(i,n){var s=i+n;t(s+".name",this.name),t(s+".farmSkill",this.skillFarming),t(s+".mineSkill",this.skillMining),t(s+".craftSkill",this.skillCrafting),t(s+".fightSkill",this.skillFighting),t(s+".hp",this.hp),t(s+".equipment",this.equipment)},getSkillAtStation:function(i){var t=i.name;return"fields"==t?this.skillFarming:"mountains"==t?this.skillMining:"workshop"==t?this.skillCrafting:0},levelup:function(i,t){"fields"==i.name?this.skillFarming++:"mountains"==i.name?this.skillMining++:"workshop"==i.name?this.skillCrafting++:"caves"!=i.name||this.healing||this.skillFighting++,this.hp<p.MAX_HP&&(this.hp++,this.hp==p.MAX_HP&&(this.healing=!1)),this.syncSlot(i.name,t)},feed:function(i,t){var n=g.instance.stationFields;0===n.supplies.food?i.removeMinion(this):n.supplies.food--},getPower:function(){return this.skillFighting+this.getEquipmentBonus()},getToughness:function(){return this.hp+this.getEquipmentBonus()},getEquipmentBonus:function(){return"tin"==this.equipment?1:"copper"==this.equipment?2:"iron"==this.equipment?3:0},damage:function(i,t,n){this.hp-=n,this.hp<=0?i.removeMinion(this):(this.hp<p.MIN_CAVE_HP&&(this.healing=!0),this.syncSlot(i.name,t))}}),m=base.extend(Object,"Station",{constructor:function(i){this.name=i,this.maxMinions=4,this.minions=[],this.production=0,"fields"==this.name?(this.supplies={mana:20,food:20},this.producing={mana:0,food:0}):"mountains"==this.name?(this.supplies={tin:0,copper:0,iron:0},this.producing={tin:0,copper:0,iron:0}):"workshop"==this.name?(this.supplies={tinA:0,copperA:0,ironA:0},this.producing={tinA:0,copperA:0,ironA:0}):(this.supplies={},this.producing={}),this.removals=[],this.syncGui();for(var t=0;t<this.maxMinions;t++)this.clearSlot(t)},addMinion:function(i){return this.minions.length<this.maxMinions?(this.minions.push(i),i.syncSlot(this.name,this.minions.length-1),this.calculateProduction(),this.syncGui(),!0):!1},removeMinion:function(i){this.removals.push(i)},flushRemovals:function(){var i;if(0!==this.removals.length){var t=g.instance.selectedSlot;for(i=0;i<this.removals.length;i++){var n=this.removals[i],s=this.minions.indexOf(n);-1!=s&&(null!==t&&this==t.station&&(s==t.slot?(t=null,g.instance.setSelectedSlot(t)):s<t.slot&&(t={station:t.station,slot:t.slot-1},g.instance.setSelectedSlot(t))),this.minions.splice(s,1))}for(i=0;i<this.minions.length;i++)this.minions[i].syncSlot(this.name,i);for(i=this.minions.length;i<this.maxMinions;i++)this.clearSlot(i);this.calculateProduction(),this.reduceProducing(),this.syncGui(),this.removals=[]}},reduceProducing:function(){for(;this.production<this.getTotalProducing();)if("fields"==this.name)if(this.producing.mana>0)this.producing.mana--;else{if(!(this.producing.food>0))break;this.producing.food--}else if("mountains"==this.name)if(this.producing.tin>0)this.producing.tin--;else if(this.producing.copper>0)this.producing.copper--;else{if(!(this.producing.iron>0))break;this.producing.iron--}else{if("workshop"!=this.name)break;if(this.producing.tinA>0)this.producing.tinA--;else if(this.producing.copperA>0)this.producing.copperA--;else{if(!(this.producing.ironA>0))break;this.producing.ironA--}}},clearSlot:function(i){var n=this.name+i;t(n+".name","null"),t(n+".farmSkill",0),t(n+".mineSkill",0),t(n+".craftSkill",0),t(n+".fightSkill",0),t(n+".hp",0),t(n+".equipment","none")},gatherSupplies:function(){if("fields"==this.name)this.supplies.mana+=this.producing.mana,this.supplies.food+=this.producing.food;else if("mountains"==this.name)this.supplies.tin+=this.producing.tin,this.supplies.copper+=this.producing.copper,this.supplies.iron+=this.producing.iron;else if("workshop"==this.name){var i,t=g.instance.stationMountains;t.supplies.tin>0&&(i=Math.min(this.producing.tinA,t.supplies.tin),t.supplies.tin-=i,this.supplies.tinA+=i),t.supplies.copper>0&&(i=Math.min(this.producing.copperA,t.supplies.copper),t.supplies.copper-=i,this.supplies.copperA+=i),t.supplies.iron>0&&(i=Math.min(this.producing.ironA,t.supplies.iron),t.supplies.iron-=i,this.supplies.ironA+=i),t.syncGui()}else if("caves"==this.name){for(var n=0;n<this.minions.length;n++){var s=this.minions[n],e=Math.random()-s.getEquipmentBonus();!s.healing&&e<p.CAVE_HURT&&s.damage(this,n,1)}this.flushRemovals()}this.syncGui()},levelupMinions:function(){for(var i=0;i<this.minions.length;i++)this.minions[i].levelup(this,i);this.calculateProduction(),this.syncGui()},feedMinions:function(){for(var i=0;i<this.minions.length;i++)this.minions[i].feed(this,i);this.flushRemovals()},calculateProduction:function(){this.production=0;for(var i=0;i<this.minions.length;i++)this.production+=this.minions[i].getSkillAtStation(this)},syncGui:function(){"fields"==this.name?(t("manaText",this.supplies.mana),t("foodText",this.supplies.food),t("plantText",this.producing.mana+"/"+this.producing.food)):"mountains"==this.name?(t("tinText",this.supplies.tin),t("copperText",this.supplies.copper),t("ironText",this.supplies.iron),t("oreText",this.producing.tin+"/"+this.producing.copper+"/"+this.producing.iron)):"workshop"==this.name&&(t("tinAText",this.supplies.tinA),t("copperAText",this.supplies.copperA),t("ironAText",this.supplies.ironA),t("armorText",this.producing.tinA+"/"+this.producing.copperA+"/"+this.producing.ironA)),t(this.name+".PP",this.getTotalProducing()+"/"+this.production),null!==g.instance&&g.instance.syncGui()},produceMore:function(i){this.producing[i]++,this.getTotalProducing()>this.production?this.producing[i]--:this.syncGui()},produceLess:function(i){this.producing[i]>0&&(this.producing[i]--,this.syncGui())},getTotalProducing:function(){return"fields"==this.name?this.producing.mana*p.PP_MANA+this.producing.food*p.PP_FOOD:"mountains"==this.name?this.producing.tin*p.PP_TIN+this.producing.copper*p.PP_COPPER+this.producing.iron*p.PP_IRON:"workshop"==this.name?this.producing.tinA*p.PP_TIN+this.producing.copperA*p.PP_COPPER+this.producing.ironA*p.PP_IRON:0}}),g=base.extend(u.Sprite,"Game",{constructor:function(){this.stationFields=new m("fields"),this.stationMountains=new m("mountains"),this.stationWorkshop=new m("workshop"),this.stationCaves=new m("caves"),this.stations=[this.stationFields,this.stationMountains,this.stationWorkshop,this.stationCaves],this.tickCount=0,this.selectedSlot=null,this.heroPower=7,this.heroHp=15,this.syncGui()},update:u.listener(u.EventTick.ID,function(i){this.tickCount++,this.tickCount%300===0&&this.gatherSupplies(),this.tickCount%1200===0&&(this.feedMinions(),this.levelupMinions())}),gatherSupplies:function(){for(var i=0;i<this.stations.length;i++)this.stations[i].gatherSupplies()},levelupMinions:function(){for(var i=0;i<this.stations.length;i++)this.stations[i].levelupMinions();this.heroPower+=Math.floor(this.tickCount/24e3)+5,this.heroHp+=Math.floor(this.tickCount/24e3)+5,this.syncGui()},feedMinions:function(){for(var i=0;i<this.stations.length;i++)this.stations[i].feedMinions()},setSelectedSlot:function(i){var n=this.selectedSlot;this.selectedSlot=i,null!==n&&t(n.station.name+n.slot+".selected",void 0),null!==i&&t(i.station.name+i.slot+".selected",!0)},getSelectedMinion:function(){return null===this.selectedSlot?null:this.selectedSlot.station.minions[this.selectedSlot.slot]},syncGui:function(){for(var i=0,n=25,s=0;s<this.stations.length;s++)for(var e=this.stations[s],o=0;o<e.minions.length;o++){var h=e.minions[o];i+=h.getPower(),n+=h.getToughness()}t("playerText",i+"/"+n),t("heroText",this.heroPower+"/"+this.heroHp),t("difference",this.heroPower-i+"/"+(this.heroHp-n)),i>this.heroPower&&n>this.heroHp?c.menuManager.setMenu(new l.MenuPlay("gui/win")):this.heroPower>i&&this.heroHp>n&&c.menuManager.setMenu(new l.MenuPlay("gui/lose"))}});i.Game=g,g.prototype.compile(),g.instance=null,i.init=function(){g.instance=new g,t("summon",n);var i,l,u,p=g.instance,c=[["Fields","mana","food"],["Mountains","tin","copper","iron"],["Workshop","tinA","copperA","ironA"]];for(l=0;l<c.length;l++)for(i=p["station"+c[l][0]],u=1;u<c[l].length;u++){var d=c[l][u];t(d+"Up",s(i,d)),t(d+"Down",e(i,d))}for(l=0;l<p.stations.length;l++)for(i=p.stations[l],u=0;u<i.maxMinions;u++)t(i.name+u+".box",o(i,u));for(l=0;l<p.stations.length;l++)i=p.stations[l],t(i.name+"Move",h(i));var m=["tin","copper","iron"];for(l=0;l<m.length;l++){var f=m[l];t(f+"Equip",r(f))}t("instructions",a)}});