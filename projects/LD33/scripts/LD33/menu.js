base.registerModule("menu",function(t){var s=base.importModule("engine"),e=base.importModule("gui"),y=(base.importModule("level"),base.importModule("util")),o=base.importModule("resource"),r=(base.importModule("data"),base.importModule("visual")),M=base.importModule("xml");function x(t,e){if(null!=e.getAttribute){t.x=Math.round(e.getAttribute("x")),t.y=Math.round(e.getAttribute("y"));var i=e.getAttribute("transform");if(null!==i&&i.startsWith("translate")){var n=i.substring("translate(".length);n=n.substring(0,n.length-1).split(","),t.x+=base.safeParseInt(n[0]),t.y+=base.safeParseInt(n[1])}}}var i=base.extend(e.Menu,"MenuPlay",{constructor:function t(e){this.variables={},this.svgName=e,this.constructor$Menu(),t.instance=this},addElements:function(){this.mainPanel=new S(new y.Rect(0,0,640,480),this.svgName,{name:"main"},null),this.addSprite(this.mainPanel)},render:s.listener(s.EventRender.ID,function(t){t.context.fillStyle="#FFFFFF",t.context.fillRect(0,0,t.context.canvas.width,t.context.canvas.height),this.mainPanel.render(t.context)}),onMouseDown:s.listener(s.EventMouseDown.ID,function(t){this.mainPanel.onMouseDown(t.x,t.y)}),onMouseMove:s.listener(s.EventMouseMove.ID,function(t){this.mainPanel.onMouseMove(t.x,t.y)})});i.prototype.compile(),(t.MenuPlay=i).instance=null;var n=base.extend(s.Sprite,"Component",{constructor:function(t,e,i,n){this.id=t.id,this.name=null==e?null:e.name.replace("-",null==n?"":n),this.defaultValue=i,this.visible=!0,x(this,t)},render:function(t){},onMouseDown:function(t,e){},onMouseMove:function(t,e){},getValue:function(){var t=this.name.replace("-",this.parentGroup.name),e=i.instance.variables[t];return null==e?this.defaultValue:e}}),S=base.extend([s.Group,n],"Panel",{constructor:function(t,e,i,n){this.constructor$Group(),this.constructor$Component(o.getResource(e),i,null,n),this.viewport=t,this.scrollbarV=null,this.scrollbarH=null,this.height=0,this.width=0,this.setupElements(o.getResource(e).cloneNode(!0))},setupElements:function(t){if(null!=t){var e,i,n=y.copyArray(t.getElementsByTagName("*")),s=[],o={},r={},h={};for(e=0;e<n.length;e++){var l,a=n[e];if(a.id.startsWith("Z")){var u=M.parseStyle(a.id.substring(1),"_"),c=!0;if("text"==u.type)s.push(new C(a,u,this.name));else if("button"==u.type)s.push(new H(a,u,this.name)),c=null!=u.toggle;else if("scrollbarV"==u.type)l=new k(a,u,this.name),s.push(l),r[u.name]=l;else if("scrollbarH"==u.type)l=new L(a,u,this.name),s.push(l),h[u.name]=l;else if("viewport"==u.type){var g={};x(g,a);var f=g.x,d=g.y,p=Math.round(a.getAttribute("width")),m=Math.round(a.getAttribute("height")),b=new y.Rect(f,d,p,m);i=null!=u.content?u.content:u.name,l=new S(b,"gui/"+i,u,this.name),s.push(l),o[u.name]=l}c&&a.parentNode.removeChild(a)}}for(i in o){var v=o[i],w=r[i];null!=w&&(v.scrollbarV=w),null!=(w=h[i])&&(v.scrollbarH=w)}for(this.addSprite(new P(t),null,this.name),this.width=t.getElementsByTagName("svg")[0].getAttribute("width"),this.height=t.getElementsByTagName("svg")[0].getAttribute("height"),e=0;e<s.length;e++)this.addSprite(s[e])}},render:function(t){t.save(),t.beginPath();var e=this.viewport;t.rect(e.left,e.top,e.width,e.height),t.clip(),t.translate(e.left,e.top),t.translate(-this.getProgressH(),-this.getProgressV());for(var i=0;i<this.sprites.length;i++){var n=this.sprites[i];n.visible&&n.render(t)}t.restore()},onMouseDown:function(t,e){if(this.viewport.collidepoint(t,e)){t-=this.viewport.left-this.getProgressH(),e-=this.viewport.top-this.getProgressV();for(var i=0;i<this.sprites.length;i++){this.sprites[i].onMouseDown(t,e)}}},onMouseMove:function(t,e){if(this.viewport.collidepoint(t,e)){t-=this.viewport.left-this.getProgressH(),e-=this.viewport.top-this.getProgressV();for(var i=0;i<this.sprites.length;i++){this.sprites[i].onMouseMove(t,e)}}},getProgressV:function(){return null===this.scrollbarV?0:Math.round(this.scrollbarV.percent*(this.height-this.viewport.height))},getProgressH:function(){return null===this.scrollbarH?0:Math.round(this.scrollbarH.percent*(this.width-this.viewport.width))}});S.prototype.compile();var P=base.extend(n,"SvgComponent",{constructor:function(t,e,i){this.constructor$Component(t,e,null,i);var n=function(t){M.removeMetadata(t);var e=s.makeCanvas(t,t.width,t.height);return canvg(e,t),e}(t);this.sheet=r.splitSheet(n,64,64),this.width=n.width,this.height=n.height},render:function(t){for(var e=0;e<this.width;e+=64)for(var i=0;i<this.height;i+=64)t.drawImage(this.sheet.get([e/64,i/64]),e,i)}}),C=base.extend(n,"TextComponent",{constructor:function(t,e,i){this.constructor$Component(t,e,"<text>",i);var n=base.safeParseInt(t.style.fontSize);this.font=t.style.fontSize+" "+t.style.fontFamily;t.getElementsByTagName("tspan")[0];this.fillStyle=t.style.fill,this.x-=n,this.y-=n},render:function(t){t.font=this.font,t.fillStyle=this.fillStyle,t.fillText(this.getValue(),this.x,this.y)}}),h=base.extend(n,"RectComponent",{constructor:function(t,e,i,n){this.constructor$Component(t,e,i,n),this.width=Math.round(t.getAttribute("width")),this.height=Math.round(t.getAttribute("height")),this.fillStyle=t.style.fill,this.strokeStyle=t.style.stroke,this.strokeWidth=base.safeParseInt(t.style["stroke-width"])},render:function(t){"none"!=this.fillStyle&&(t.fillStyle=this.fillStyle,t.fillRect(this.x,this.y,this.getWidth(),this.height)),"none"!=this.strokeStyle&&(t.strokeStyle=this.strokeStyle,t.lineWidth=this.strokeWidth,t.strokeRect(this.x,this.y,this.getWidth(),this.height))},getWidth:function(){return this.width},onMouseDown:function(t,e){new y.Rect(this.x,this.y,this.getWidth(),this.height).collidepoint(t,e)&&this.onClick(t,e)},onClick:function(t,e){}}),H=base.extend(h,"ButtonComponent",{constructor:function(t,e,i){this.constructor$RectComponent(t,e,function(){},i),this.toggle=null==e.toggle?null:e.toggle.replace("-",null===i?"":i)},onClick:function(t,e){var i=this.getValue();null!=i&&i()},render:function(t){null!==this.toggle&&i.instance.variables[this.toggle]&&this.render$RectComponent(t)}});H.prototype.compile();var l=base.extend(h,"ScrollBarComponent",{constructor:function(t,e,i){this.constructor$RectComponent(t,e,null,i),this.grabPoint=-1,this.rangeLow=this.getLow(),this.rangeHigh=this.getHigh(),this.setSize(20),this.percent=0},onClick:function(t,e){this.grabPoint=this.coord(t,e)-this.getLow()},onUnClick:s.listener(s.EventMouseUp.ID,function(t){this.grabPoint=-1}),onMouseMove:function(t,e){if(-1!=this.grabPoint){var i=this.coord(t,e)-this.grabPoint;i<this.rangeLow?i=this.rangeLow:i>this.rangeHigh&&(i=this.rangeHigh),this.setLow(i),this.percent=(this.getLow()-this.rangeLow)/(this.rangeHigh-this.rangeLow)}},getLow:base.abstractMethod,setLow:base.abstractMethod,getHigh:base.abstractMethod,setSize:base.abstractMethod,coord:base.abstractMethod});l.prototype.compile();var k=base.extend(l,"ScrollBarV",{constructor:function(t,e,i){this.constructor$ScrollBarComponent(t,e,null,i)},getLow:function(){return this.y},setLow:function(t){this.y=t},getHigh:function(){return this.y+this.height},setSize:function(t){this.height=t},coord:function(t,e){return e}}),L=base.extend(l,"ScrollBarH",{constructor:function(t,e,i){this.constructor$ScrollBarComponent(t,e,null,i)},getLow:function(){return this.x},setLow:function(t){this.x=t},getHigh:function(){return this.x+this.width},setSize:function(t){this.width=t},coord:function(t,e){return t}})});