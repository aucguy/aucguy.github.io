base.registerModule("menu",function(t){function e(t){l.removeMetadata(t);var e=n.makeCanvas(t,t.width,t.height);return canvg(e,t),e}function i(t,e){if(null!=e.getAttribute){t.x=Math.round(e.getAttribute("x")),t.y=Math.round(e.getAttribute("y"));var i=e.getAttribute("transform");if(null!==i&&i.startsWith("translate")){var n=i.substring("translate(".length);n=n.substring(0,n.length-1).split(","),t.x+=base.safeParseInt(n[0]),t.y+=base.safeParseInt(n[1])}}}var n=base.importModule("engine"),s=base.importModule("gui"),o=(base.importModule("level"),base.importModule("util")),r=base.importModule("resource"),h=(base.importModule("data"),base.importModule("visual")),l=base.importModule("xml"),a=base.extend(s.Menu,"MenuPlay",{constructor:function w(t){this.variables={},this.svgName=t,this.constructor$Menu(),w.instance=this},addElements:function(){this.mainPanel=new c(new o.Rect(0,0,640,480),this.svgName,{name:"main"},null),this.addSprite(this.mainPanel)},render:n.listener(n.EventRender.ID,function(t){t.context.fillStyle="#FFFFFF",t.context.fillRect(0,0,t.context.canvas.width,t.context.canvas.height),this.mainPanel.render(t.context)}),onMouseDown:n.listener(n.EventMouseDown.ID,function(t){this.mainPanel.onMouseDown(t.x,t.y)}),onMouseMove:n.listener(n.EventMouseMove.ID,function(t){this.mainPanel.onMouseMove(t.x,t.y)})});a.prototype.compile(),t.MenuPlay=a,a.instance=null;var u=base.extend(n.Sprite,"Component",{constructor:function(t,e,n,s){this.id=t.id,this.name=null==e?null:e.name.replace("-",null==s?"":s),this.defaultValue=n,this.visible=!0,i(this,t)},render:function(t){},onMouseDown:function(t,e){},onMouseMove:function(t,e){},getValue:function(){var t=this.name.replace("-",this.parentGroup.name),e=a.instance.variables[t];return null==e?this.defaultValue:e}}),c=base.extend([n.Group,u],"Panel",{constructor:function(t,e,i,n){this.constructor$Group(),this.constructor$Component(r.getResource(e),i,null,n),this.viewport=t,this.scrollbarV=null,this.scrollbarH=null,this.height=0,this.width=0,this.setupElements(r.getResource(e).cloneNode(!0))},setupElements:function(t){if(null!=t){var e,n,s=o.copyArray(t.getElementsByTagName("*")),r=[],h={},a={},u={};for(e=0;e<s.length;e++){var d,v=s[e];if(v.id.startsWith("Z")){var w=l.parseStyle(v.id.substring(1),"_"),y=!0;if("text"==w.type)r.push(new f(v,w,this.name));else if("button"==w.type)r.push(new p(v,w,this.name)),y=null!=w.toggle;else if("scrollbarV"==w.type)d=new m(v,w,this.name),r.push(d),a[w.name]=d;else if("scrollbarH"==w.type)d=new b(v,w,this.name),r.push(d),u[w.name]=d;else if("viewport"==w.type){var M={};i(M,v);var x=M.x,S=M.y,P=Math.round(v.getAttribute("width")),C=Math.round(v.getAttribute("height")),H=new o.Rect(x,S,P,C);n=null!=w.content?w.content:w.name,d=new c(H,"gui/"+n,w,this.name),r.push(d),h[w.name]=d}y&&v.parentNode.removeChild(v)}}for(n in h){var k=h[n],L=a[n];null!=L&&(k.scrollbarV=L),L=u[n],null!=L&&(k.scrollbarH=L)}for(this.addSprite(new g(t),null,this.name),this.width=t.getElementsByTagName("svg")[0].getAttribute("width"),this.height=t.getElementsByTagName("svg")[0].getAttribute("height"),e=0;e<r.length;e++)this.addSprite(r[e])}},render:function(t){t.save(),t.beginPath();var e=this.viewport;t.rect(e.left,e.top,e.width,e.height),t.clip(),t.translate(e.left,e.top),t.translate(-this.getProgressH(),-this.getProgressV());for(var i=0;i<this.sprites.length;i++){var n=this.sprites[i];n.visible&&n.render(t)}t.restore()},onMouseDown:function(t,e){if(this.viewport.collidepoint(t,e)){t-=this.viewport.left-this.getProgressH(),e-=this.viewport.top-this.getProgressV();for(var i=0;i<this.sprites.length;i++){var n=this.sprites[i];n.onMouseDown(t,e)}}},onMouseMove:function(t,e){if(this.viewport.collidepoint(t,e)){t-=this.viewport.left-this.getProgressH(),e-=this.viewport.top-this.getProgressV();for(var i=0;i<this.sprites.length;i++){var n=this.sprites[i];n.onMouseMove(t,e)}}},getProgressV:function(){return null===this.scrollbarV?0:Math.round(this.scrollbarV.percent*(this.height-this.viewport.height))},getProgressH:function(){return null===this.scrollbarH?0:Math.round(this.scrollbarH.percent*(this.width-this.viewport.width))}});c.prototype.compile();var g=base.extend(u,"SvgComponent",{constructor:function(t,i,n){this.constructor$Component(t,i,null,n);var s=e(t);this.sheet=h.splitSheet(s,64,64),this.width=s.width,this.height=s.height},render:function(t){for(var e=0;e<this.width;e+=64)for(var i=0;i<this.height;i+=64)t.drawImage(this.sheet.get([e/64,i/64]),e,i)}}),f=base.extend(u,"TextComponent",{constructor:function(t,e,i){this.constructor$Component(t,e,"<text>",i);var n=base.safeParseInt(t.style.fontSize);this.font=t.style.fontSize+" "+t.style.fontFamily;t.getElementsByTagName("tspan")[0];this.fillStyle=t.style.fill,this.x-=n,this.y-=n},render:function(t){t.font=this.font,t.fillStyle=this.fillStyle,t.fillText(this.getValue(),this.x,this.y)}}),d=base.extend(u,"RectComponent",{constructor:function(t,e,i,n){this.constructor$Component(t,e,i,n),this.width=Math.round(t.getAttribute("width")),this.height=Math.round(t.getAttribute("height")),this.fillStyle=t.style.fill,this.strokeStyle=t.style.stroke,this.strokeWidth=base.safeParseInt(t.style["stroke-width"])},render:function(t){"none"!=this.fillStyle&&(t.fillStyle=this.fillStyle,t.fillRect(this.x,this.y,this.getWidth(),this.height)),"none"!=this.strokeStyle&&(t.strokeStyle=this.strokeStyle,t.lineWidth=this.strokeWidth,t.strokeRect(this.x,this.y,this.getWidth(),this.height))},getWidth:function(){return this.width},onMouseDown:function(t,e){var i=new o.Rect(this.x,this.y,this.getWidth(),this.height);i.collidepoint(t,e)&&this.onClick(t,e)},onClick:function(t,e){}}),p=base.extend(d,"ButtonComponent",{constructor:function(t,e,i){this.constructor$RectComponent(t,e,function(){},i),this.toggle=null==e.toggle?null:e.toggle.replace("-",null===i?"":i)},onClick:function(t,e){var i=this.getValue();null!=i&&i()},render:function(t){null!==this.toggle&&a.instance.variables[this.toggle]&&this.render$RectComponent(t)}});p.prototype.compile();var v=base.extend(d,"ScrollBarComponent",{constructor:function(t,e,i){this.constructor$RectComponent(t,e,null,i),this.grabPoint=-1,this.rangeLow=this.getLow(),this.rangeHigh=this.getHigh(),this.setSize(20),this.percent=0},onClick:function(t,e){this.grabPoint=this.coord(t,e)-this.getLow()},onUnClick:n.listener(n.EventMouseUp.ID,function(t){this.grabPoint=-1}),onMouseMove:function(t,e){if(-1!=this.grabPoint){var i=this.coord(t,e)-this.grabPoint;i<this.rangeLow?i=this.rangeLow:i>this.rangeHigh&&(i=this.rangeHigh),this.setLow(i),this.percent=(this.getLow()-this.rangeLow)/(this.rangeHigh-this.rangeLow)}},getLow:base.abstractMethod,setLow:base.abstractMethod,getHigh:base.abstractMethod,setSize:base.abstractMethod,coord:base.abstractMethod});v.prototype.compile();var m=base.extend(v,"ScrollBarV",{constructor:function(t,e,i){this.constructor$ScrollBarComponent(t,e,null,i)},getLow:function(){return this.y},setLow:function(t){this.y=t},getHigh:function(){return this.y+this.height},setSize:function(t){this.height=t},coord:function(t,e){return e}}),b=base.extend(v,"ScrollBarH",{constructor:function(t,e,i){this.constructor$ScrollBarComponent(t,e,null,i)},getLow:function(){return this.x},setLow:function(t){this.x=t},getHigh:function(){return this.x+this.width},setSize:function(t){this.width=t},coord:function(t,e){return t}})});